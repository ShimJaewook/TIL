# Version update

---



쿠버네티스에서는 pod의 버전을 업데이트 하는 크게 네 가지 방법이 존재한다.
**ReCreate, Rolling Update, Blud/Green, Canary**가 그 방법들이다.



### 1. ReCreate

---



![](./src/update1.png)

Deployment 컨트롤러를 통해 v1의 pod들을 제거하고 v2의 pod들을 생성하는 방법이다.

추가 리소스가 필요하지 않고 가장 단순한 방법이지만 서비스에 대한 다운타임이 발생한다는 치명적인 단점이 있다.

그래서 일시적인 정지가 가능한 서비스에 한해서 사용이 가능한 방법이다.



### 2. Rolling Update

---

![](./src/update2.png)



용어 그대로 회전식 업데이트 방법이다.

V1의 pod들을 종료시키지 않고 추가로 v2의 pod를 생성한 뒤, v1을 죽인다.

즉, v2의 pod가 생성되었을 때는 위의 그림을 기준으로 총 세 개의 pod가 운영되고 있는 상태이며 그 때 들어온 트래픽은 v1의 pod로 들어갈 수도, v2의 pod로 들어갈 수도 있다.

Recreate 방식에 비해 추가적인 자원이 필요하지만 서비스의 중단 없이 버전을 업데이트 할 수 있다는 장점이 있다.



### 3. Blue/Green

---



![](./src/update3.png)



새로운 버전의 pod들을 모두 생성한 뒤, service에 label을 바꾸어 한 번에 모든 pod들의 버전을 업데이트 하는 방식이다.

두 개의 컨트롤러로 pod들을 관리하며 , 자원이 pod의 갯수보다 두 배나 더 필요하지만 버전을 혼용하여 운영하는 단계가 없이 한 번에 넘어갈 수 있으며 새로운 버전의 pod에 문제가 발생할 경우 서비스에 라벨만 바꿔주는 방식으로 롤백이 간단하다. 

굉장히 안정적인 배포방식이지만 자원이 두 배나 필요하다는 부담은 적지 않다.



### 4. Canary

---

카나리방식은 이름만 들어서는 어떤 방식인지 추측하기 힘들다.

카나리라는 이름의 새의 이름에서 유래되었는 이 새는 공기 중 산소 농도에 민감하여 가스나 일산화탄소를 감지하는 용도로 사용되었다고 한다...

그래서 카나리 배포라고 하면 실험체를 통해 위험을 감지하고 안전이 확보가 되면 정식으로 배포하는 방식이다.

![](./src/update4-1.png)



V1의 파드들과 v2의 파드에 공통으로 존재하는 라벨을 만들어준다.(ty:app)

그리고 해당 라벨을 통해 pod들을 통제하는 service를 생성한 뒤, 

요청이 온 트레픽 중 일부는 v2로, 일부는 v1으로 보낸다.

그렇게 새로운 버전에 대한 테스트를 진행하고 문제가 발생하면 v2를 관리하고 있는 컨트롤러의 replicas를 0으로 만들어주기만 한다면 쉽게 철수가 가능하다.

위의 그림은 버전에 따른 특별한 트래픽 제어 없이 파드들을 시험한 것이고, 다음 버전의 파드들을 관리하는 service를 생성하여 트래픽을 분산하는 방법이 아래의 그림이다.



![](./src/update4-2.png)

`Ingress Controller`를 사용하여 서비스들로 흐르는 트레픽을 버전 별로 관리하는 모습이다.

예를 들어, 특정 국가에서 새로운 버전의 서비스를 테스트하는 상황에서 해당 국가의 트래픽은 새로운 버전의 pod로 보내고 기타 국가들은 이전 버전의 pod들로 트래픽을 보내는 것이 위의 카나리 방식의 예이다.

그렇게 성공적으로 카나리가 살아 있다면 ,

![](./src/update4-3.png)

위의 그림과 같이 service의 라벨을 수정하여 새로운 버전으로 정착하면 된다.

카나리 역할을 하는 다음 버전의  pod의 수 만큼 추가 자원이 필요하지만 down time이 없다는 장점이 있다.